<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>dcsçš„åšå®¢</title>
  <subtitle>å°½é‡ä¸çå†™</subtitle>
  <link href="/blog/atom.xml" rel="self"/>
  
  <link href="http://lh2907883.github.io/blog/"/>
  <updated>2017-05-14T09:02:29.000Z</updated>
  <id>http://lh2907883.github.io/blog/</id>
  
  <author>
    <name>lihao</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>webç¦»çº¿åº”ç”¨</title>
    <link href="http://lh2907883.github.io/blog/2017/05/14/web%E7%A6%BB%E7%BA%BF%E5%BA%94%E7%94%A8/"/>
    <id>http://lh2907883.github.io/blog/2017/05/14/webç¦»çº¿åº”ç”¨/</id>
    <published>2017-05-14T07:57:53.000Z</published>
    <updated>2017-05-14T09:02:29.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨"><a href="#ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨" class="headerlink" title="ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨"></a>ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨</h2><p>åœ¨æ­£å¸¸æƒ…å†µä¸‹,å®¢æˆ·ç«¯ä½¿ç”¨HTTPåè®®é€šè¿‡ç½‘ç»œå¾—åˆ°æœåŠ¡å™¨çš„èµ„æº,ç„¶åå±•ç¤º,ä½†æ˜¯å¦‚æœåœ¨ç½‘ç»œæ–­å¼€çš„æƒ…å†µä¸‹,å®¢æˆ·ç«¯å°±æ²¡åŠæ³•äº†,è¿™æ—¶å°±éœ€è¦ä¸€ç§æŠ€æœ¯å»è§£å†³è¿™ä¸€é—®é¢˜,ç›®å‰æœ‰ä¸¤ç§æ–¹å¼:<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Using_the_application_cache" target="_blank" rel="external">AppCache</a>å’Œ<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers#Browser_compatibility" target="_blank" rel="external">Service Workers</a>,ä»–ä»¬éƒ½æ˜¯é€šè¿‡åœ¨æ–­ç½‘æ—¶è¯»å–æœ¬åœ°ç¼“å­˜èµ„æºæ¥å®ç°webåº”ç”¨çš„ç¦»çº¿è®¿é—®çš„.</p>
<h2 id="æ¯”è¾ƒAppCacheå’ŒService-Workers"><a href="#æ¯”è¾ƒAppCacheå’ŒService-Workers" class="headerlink" title="æ¯”è¾ƒAppCacheå’ŒService Workers"></a>æ¯”è¾ƒAppCacheå’ŒService Workers</h2><h3 id="ä½¿ç”¨æ–¹å¼"><a href="#ä½¿ç”¨æ–¹å¼" class="headerlink" title="ä½¿ç”¨æ–¹å¼"></a>ä½¿ç”¨æ–¹å¼</h3><p>AppCacheé€šè¿‡æŒ‡å®šç¼“å­˜æ¸…å•æ–‡ä»¶æ¥è®¾ç½®å“ªäº›èµ„æºéœ€è¦è¢«ç¼“å­˜</p>
<p>Service Workersåˆ™æœ‰æ›´æ–°å¼ºå¤§çš„APIæ¥é€šè¿‡è„šæœ¬ç²¾å‡†æ§åˆ¶ç¼“å­˜(åŒ…æ‹¬æ›´æ–°,è¿½åŠ ,åˆ é™¤ç¼“å­˜)</p>
<h3 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h3><p>ä¸‹å›¾æ˜¯å„å¤§æµè§ˆå™¨å¯¹AppCacheçš„æ”¯æŒæƒ…å†µ,å¯ä»¥çœ‹å‡ºåŸºæœ¬éƒ½æ”¯æŒ<br><img src="https://lh2907883.github.io/store/blog/web%E7%A6%BB%E7%BA%BF%E5%BA%94%E7%94%A8/1.png" alt=""></p>
<p>è€ŒService Workersè¿˜æ˜¯æœ‰ä¸€éƒ¨åˆ†æµè§ˆå™¨ä¸æ”¯æŒçš„(ç‰¹åˆ«æ˜¯ç§»åŠ¨å¹³å°)<br><img src="https://lh2907883.github.io/store/blog/web%E7%A6%BB%E7%BA%BF%E5%BA%94%E7%94%A8/2.png" alt=""></p>
<h3 id="W3Cæ ‡å‡†"><a href="#W3Cæ ‡å‡†" class="headerlink" title="W3Cæ ‡å‡†"></a>W3Cæ ‡å‡†</h3><p>å¦‚æœä½ çœ‹è¿‡<a href="https://developer.mozilla.org/zh-CN/docs/Web/HTML/Using_the_application_cache" target="_blank" rel="external">AppCache</a>çš„æ–‡æ¡£,ä½ ä¼šå‘ç°</p>
<blockquote>
<p>è¯¥ç‰¹æ€§å·²ç»ä»Webæ ‡å‡†ä¸­åˆ é™¤ï¼Œè™½ç„¶ä¸€äº›æµè§ˆå™¨ç›®å‰ä»ç„¶æ”¯æŒå®ƒï¼Œä½†ä¹Ÿè®¸ä¼šåœ¨æœªæ¥çš„æŸä¸ªæ—¶é—´åœæ­¢æ”¯æŒï¼Œè¯·å°½é‡ä¸è¦ä½¿ç”¨è¯¥ç‰¹æ€§ã€‚</p>
<p>åœ¨æ­¤åˆ»ä½¿ç”¨è¿™é‡Œæè¿°çš„åº”ç”¨ç¨‹åºç¼“å­˜åŠŸèƒ½é«˜åº¦ä¸é¼“åŠ±; å®ƒæ­£åœ¨å¤„äºä»Webå¹³å°ä¸­è¢«åˆ é™¤çš„è¿‡ç¨‹ã€‚è¯·æ”¹ç”¨<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers#Browser_compatibility" target="_blank" rel="external">Service Workers</a>ä»£æ›¿ã€‚</p>
</blockquote>
<p>æˆ‘ä¸ªäººè®¤ä¸ºService Workerså„æ–¹é¢éƒ½è¦ä¼˜äºAppCache,é™¤äº†å…¼å®¹æ€§,ä¸è¿‡æ—¢ç„¶Service Workerså·²ç»æ˜¯W3Cæ ‡å‡†,æƒ³å¿…æœªæ¥çš„æ”¯æŒæƒ…å†µåº”è¯¥ä¼šå¥½ä¸€äº›,æ‰€ä»¥ä¸‹é¢æˆ‘ä»¬å°†è¯¦ç»†è®¨è®ºService Workersçš„ç”¨æ³•</p>
<h2 id="ä½¿ç”¨Service-Workersçš„å‰ææ¡ä»¶"><a href="#ä½¿ç”¨Service-Workersçš„å‰ææ¡ä»¶" class="headerlink" title="ä½¿ç”¨Service Workersçš„å‰ææ¡ä»¶"></a>ä½¿ç”¨Service Workersçš„å‰ææ¡ä»¶</h2><blockquote>
<p>åœ¨å·²ç»æ”¯æŒ serivce workers çš„æµè§ˆå™¨çš„ç‰ˆæœ¬ä¸­, å¾ˆå¤šç‰¹æ€§æ²¡æœ‰é»˜è®¤å¼€å¯, éœ€è¦å¼€å¯ä¸€ä¸‹æµè§ˆå™¨çš„ç›¸å…³é…ç½®ï¼š</p>
<ul>
<li>Firefox Nightly: è®¿é—® about:config å¹¶è®¾ç½® dom.serviceWorkers.enabled çš„å€¼ä¸º true; é‡å¯æµè§ˆå™¨ï¼›</li>
<li>Chrome Canary: è®¿é—® chrome://flags å¹¶å¼€å¯ experimental-web-platform-features; é‡å¯æµè§ˆå™¨ (æ³¨æ„ï¼šæœ‰äº›ç‰¹æ€§åœ¨Chromeä¸­æ²¡æœ‰é»˜è®¤å¼€æ”¾æ”¯æŒ)ï¼›</li>
<li>Opera: è®¿é—® opera://flags å¹¶å¼€å¯ ServiceWorker çš„æ”¯æŒ; é‡å¯æµè§ˆå™¨ã€‚ </li>
</ul>
<p>å¦å¤–ï¼Œä½ éœ€è¦é€šè¿‡ <strong>HTTPS</strong> æ¥è®¿é—®ä½ çš„é¡µé¢ â€” å‡ºäºå®‰å…¨åŸå› ï¼ŒService Workers è¦æ±‚è¦åœ¨å¿…é¡»åœ¨ HTTPS ä¸‹æ‰èƒ½è¿è¡Œã€‚Github æ˜¯ä¸ªç”¨æ¥æµ‹è¯•çš„å¥½åœ°æ–¹ï¼Œå› ä¸ºå®ƒå°±æ”¯æŒHTTPSã€‚ä¸ºäº†ä¾¿äºæœ¬åœ°å¼€å‘ï¼Œlocalhost ä¹Ÿè¢«æµè§ˆå™¨è®¤ä¸ºæ˜¯å®‰å…¨æºã€‚</p>
</blockquote>
<h2 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><h3 id="æ³¨å†Œservice-worker"><a href="#æ³¨å†Œservice-worker" class="headerlink" title="æ³¨å†Œservice worker"></a>æ³¨å†Œservice worker</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * @scriptURL ServiceWorkerè„šæœ¬èµ„æºè·¯å¾„(å¯ä»¥æ˜¯ç»å¯¹æˆ–è€…ç›¸å¯¹å½“å‰URLçš„è·¯å¾„)</div><div class="line"> * @options &#123;scope: './'&#125; scopeæ˜¯ä¸€ä¸ªè·¯å¾„,é»˜è®¤å€¼å°±æ˜¯'./',å®ƒæ€»æ˜¯ç›¸å¯¹äºServiceWorkerè„šæœ¬èµ„æºè·¯å¾„çš„,scopeæŒ‡å®šäº†ä¸€ä¸ªServiceWorkerçš„ç”Ÿæ•ˆèŒƒå›´,åªæœ‰åœ¨è¿™ä¸ªè·¯å¾„èŒƒå›´å†…çš„èµ„æºæ‰èƒ½æ”¯æŒç¦»çº¿è®¿é—®(æ‰€ä»¥è·¨åŸŸçš„èµ„æºæ˜¯æ²¡æ³•ç¦»çº¿è®¿é—®çš„)</div><div class="line"> */</div><div class="line">ServiceWorkerContainer.register(scriptURL, options)</div><div class="line">    .then(</div><div class="line">        <span class="function"><span class="keyword">function</span>(<span class="params">ServiceWorkerRegistration</span>) </span>&#123;</div><div class="line">            <span class="comment">// do something</span></div><div class="line">        &#125;</div><div class="line">);</div></pre></td></tr></table></figure>
<p>ä»£ç å¦‚ä¸‹:<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//å…¼å®¹æ€§åˆ¤æ–­</span></div><div class="line"><span class="keyword">if</span> (<span class="string">'serviceWorker'</span> <span class="keyword">in</span> navigator) &#123;</div><div class="line">    navigator.serviceWorker.register(<span class="string">'sw.js'</span>, &#123;<span class="attr">scope</span>: <span class="string">'./'</span>&#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">reg</span>) </span>&#123;</div><div class="line">        <span class="keyword">if</span> (reg.installing) &#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'Service worker installing'</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reg.waiting) &#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'Service worker installed'</span>);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (reg.active) &#123;</div><div class="line">            <span class="built_in">console</span>.log(<span class="string">'Service worker active'</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;).catch(<span class="function"><span class="keyword">function</span>(<span class="params">error</span>) </span>&#123;</div><div class="line">        <span class="comment">// registration failed</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'Registration failed with '</span> + error);</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>äº‹å®ä¸Šå½“æµè§ˆå™¨è¿è¡Œä¸Šé¢çš„ä»£ç æ—¶, ä¼šå…ˆæ£€æµ‹æ˜¯å¦ä¹‹å‰å°±è·å–å¹¶æ³¨å†Œè¿‡<strong>sw.js</strong></p>
<ul>
<li>å¦‚æœæ˜¯<strong>é¦–æ¬¡è¿è¡Œ</strong>,é‚£å°±å…ˆä¸‹è½½å¹¶ä¿å­˜åœ¨æœ¬åœ°, chromeä¸­å¯ä»¥åœ¨<em>Application -&gt; Service Workers</em>é¢æ¿ä¸­æŸ¥çœ‹<br><img src="https://lh2907883.github.io/store/blog/web%E7%A6%BB%E7%BA%BF%E5%BA%94%E7%94%A8/3.png" alt=""><br>è¿™æ—¶ä¼šè§¦å‘Service Workerçš„<code>install</code>äº‹ä»¶,ä¹‹åä¼šè¿›å…¥<code>navigator.serviceWorker.register</code>è¿”å›çš„<code>Promise.then</code>,çŠ¶æ€<code>state</code>ä¸º<code>installing</code>. </li>
<li>å¦‚æœå‘ç°æœ¬åœ°å·²ç»æœ‰<strong>sw.js</strong> <em>(å³ä½¿æœ¬åœ°çš„<strong>sw.js</strong>ä¸æ˜¯æœ€æ–°ä»£ç ,è¿™æ¬¡è®¿é—®ä»»ç„¶ä¼šä½¿ç”¨æœ¬åœ°<strong>sw.js</strong>çš„ä»£ç )</em>,é‚£ä¹ˆä¼šç›´æ¥è¿›å…¥<code>navigator.serviceWorker.register</code>è¿”å›çš„<code>Promise.then</code>,çŠ¶æ€<code>state</code>ä¸º<code>activated</code>,è¿™æ—¶Service Workerä¸ºå·²æ¿€æ´»çŠ¶æ€,åé¢åªè¦æ˜¯æœ‰<code>scope</code>èŒƒå›´å†…çš„è¯·æ±‚éƒ½ä¼šè¢«Service Workerçš„<code>fetch</code>äº‹ä»¶æ‹¦æˆª<em>(æ³¨æ„:å¦‚æœåœ¨scopeä¸‹çš„htmlé¡µé¢è®¿é—®äº†è·¨åŸŸçš„èµ„æº,æ¯”å¦‚å›¾ç‰‡ä»€ä¹ˆçš„,é‚£è¿™ä¸ªè·¨åŸŸèµ„æºè¯·æ±‚ä¹Ÿä¼šè¢«æ‹¦æˆª)</em>,åœ¨<code>fetch</code>çš„å›è°ƒå‡½æ•°é‡Œé¢ä½ å¯ä»¥è‡ªè¡Œæ§åˆ¶æ˜¯<strong>è¯»ç¼“å­˜</strong>,è¿˜æ˜¯<strong>è¯·æ±‚ç½‘ç»œ</strong>,ä½ ç”šè‡³å¯ä»¥<strong>ä¼ªé€ å“åº”æ•°æ®</strong> <em>(æˆ‘æƒ³è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆService Workeråªæ”¯æŒHTTPSçš„åŸå› )</em></li>
<li>å¦‚æœå‘ç°æœ¬åœ°å·²ç»æœ‰<strong>sw.js</strong>å¹¶ä¸”æœ¬åœ°çš„<strong>sw.js</strong>ä¸æ˜¯æœ€æ–°ä»£ç ,é‚£ä¹ˆ<strong>sw.js</strong>ä¼šè‡ªåŠ¨æ›´æ–°,å¹¶è§¦å‘Service Workerçš„<code>install</code>äº‹ä»¶,åœ¨ä¸‹æ¬¡è®¿é—®é¡µé¢æ—¶å°†ä½¿ç”¨æ–°ç‰ˆæœ¬çš„<strong>sw.js</strong>.</li>
</ul>
<h3 id="å…³äºsw-js"><a href="#å…³äºsw-js" class="headerlink" title="å…³äºsw.js"></a>å…³äºsw.js</h3><h4 id="sw-jsçš„èŒè´£"><a href="#sw-jsçš„èŒè´£" class="headerlink" title="sw.jsçš„èŒè´£"></a>sw.jsçš„èŒè´£</h4><p>ä»ä¸Šé¢çš„æè¿°,æˆ‘ä»¬å¯ä»¥çœ‹å‡º<strong>sw.js</strong>çš„èŒè´£å…¶å®æ˜¯æ§åˆ¶webåº”ç”¨ä¸­èµ„æºçš„è®¿é—®ç­–ç•¥,ä»–å’Œå…·ä½“çš„ä¸šåŠ¡é€»è¾‘,UIæ“ä½œéƒ½æ²¡æœ‰ä»»ä½•å…³ç³»,å®˜æ–¹è¯´æ˜:</p>
<blockquote>
<p>å¦‚æœæ³¨å†ŒæˆåŠŸï¼Œservice worker å°±åœ¨ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ServiceWorkerGlobalScope" target="_blank" rel="external">ServiceWorkerGlobalScope</a> ç¯å¢ƒä¸­è¿è¡Œï¼› è¿™æ˜¯ä¸€ä¸ªç‰¹æ®Šç±»å‹çš„ woker ä¸Šä¸‹æ–‡è¿è¡Œç¯å¢ƒï¼Œä¸ä¸»è¿è¡Œçº¿ç¨‹ï¼ˆæ‰§è¡Œè„šæœ¬ï¼‰ç›¸ç‹¬ç«‹ï¼ŒåŒæ—¶ä¹Ÿæ²¡æœ‰è®¿é—® DOM çš„èƒ½åŠ›ã€‚</p>
</blockquote>
<h4 id="å…·ä½“å®ç°"><a href="#å…·ä½“å®ç°" class="headerlink" title="å…·ä½“å®ç°"></a>å…·ä½“å®ç°</h4><ul>
<li>æ³¨å†Œinstalläº‹ä»¶<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="comment">//console.log('sw.js install');</span></div><div class="line">    event.waitUntil(</div><div class="line">        caches.open(<span class="string">'v1'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> cache.addAll([</div><div class="line">                <span class="string">'/demo/service-workers/'</span>,</div><div class="line">                <span class="string">'/demo/service-workers/index.html'</span>,</div><div class="line">                <span class="string">'/demo/service-workers/js/main.js'</span>,</div><div class="line">                <span class="string">'/demo/service-workers/json/data.json'</span>,</div><div class="line">                <span class="string">'/demo/service-workers/images/1.jpg'</span>,</div><div class="line">                <span class="string">'/demo/service-workers/images/2.jpg'</span>,</div><div class="line">            ]);</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<blockquote>
<p>install äº‹ä»¶ä¸€èˆ¬æ˜¯è¢«ç”¨æ¥å¡«å……ä½ çš„æµè§ˆå™¨çš„ç¦»çº¿ç¼“å­˜èƒ½åŠ›ã€‚ä¸ºäº†è¾¾æˆè¿™ä¸ªç›®çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨äº† Service Worker çš„ æ–°çš„æ ‡å¿—æ€§çš„å­˜å‚¨ <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Cache" target="_blank" rel="external">API â€” cache</a> â€” ä¸€ä¸ª service worker ä¸Šçš„å…¨å±€å¯¹è±¡ï¼Œå®ƒä½¿æˆ‘ä»¬å¯ä»¥å­˜å‚¨ç½‘ç»œå“åº”å‘æ¥çš„èµ„æºï¼Œå¹¶ä¸”æ ¹æ®å®ƒä»¬çš„è¯·æ±‚æ¥ç”Ÿæˆkeyã€‚è¿™ä¸ª API å’Œæµè§ˆå™¨çš„æ ‡å‡†çš„ç¼“å­˜å·¥ä½œåŸç†å¾ˆç›¸ä¼¼ï¼Œä½†æ˜¯æ˜¯ç‰¹å®šä½ çš„åŸŸçš„ã€‚å®ƒä¼šä¸€ç›´æŒä¹…å­˜åœ¨ï¼Œç›´åˆ°ä½ å‘Šè¯‰å®ƒä¸å†å­˜å‚¨ï¼Œä½ æ‹¥æœ‰å…¨éƒ¨çš„æ§åˆ¶æƒã€‚<br>æ³¨æ„:  Cache API  å¹¶ä¸è¢«æ¯ä¸ªæµè§ˆå™¨æ”¯æŒã€‚ï¼ˆæŸ¥çœ‹ Browser support  éƒ¨åˆ†äº†è§£æ›´å¤šä¿¡æ¯ã€‚ï¼‰ å¦‚æœä½ ç°åœ¨å°±æƒ³ä½¿ç”¨å®ƒï¼Œå¯ä»¥è€ƒè™‘é‡‡ç”¨ä¸€ä¸ª polyfillï¼Œæ¯”å¦‚ <a href="https://github.com/Polymer/topeka/blob/master/sw.js" target="_blank" rel="external">Google topeka demo</a>ï¼Œæˆ–è€…æŠŠä½ çš„èµ„æºå­˜å‚¨åœ¨ <a href="https://developer.mozilla.org/zh-CN/docs/Glossary/IndexedDB" target="_blank" rel="external">IndexedDB</a> ä¸­ã€‚</p>
</blockquote>
<p>ç¼“å­˜æ–¹æ¡ˆæœ‰å¾ˆå¤šç§, ç¤ºä¾‹ä»£ç ä¸­é‡‡ç”¨<code>Cache</code>, å€¼å¾—æ³¨æ„çš„æ˜¯<code>cache.addAll</code>å¯ä¸ä»…ä»…åªæ˜¯è®°å½•éœ€è¦ç¼“å­˜çš„èµ„æºURLåˆ—è¡¨, å®ƒåŒæ—¶è¿˜ä¼š<code>fetch</code>è¿™äº›èµ„æºæŠŠå“åº”æ•°æ®ç¼“å­˜èµ·æ¥,ä»¥ä¾¿åé¢è®¿é—®çš„æ—¶å€™ä½¿ç”¨ <em>(å¦‚æœæ˜¯ä¸€ä¸ªå¤æ‚çš„webåº”ç”¨,ä¸ªäººè§‰å¾—æœ‰äº›ä¸å¤ªåˆç†,è°åˆä¼šåœ¨é¡µé¢åˆšåˆšè¿›æ¥æ—¶å°±åŠ è½½æ‰€æœ‰èµ„æºå‘¢?)</em></p>
<ul>
<li>æ³¨å†Œfetchäº‹ä»¶<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="comment">//console.log(event.request);</span></div><div class="line">    <span class="comment">//console.log(caches);</span></div><div class="line">    event.respondWith(</div><div class="line">        caches.match(event.request)</div><div class="line">        .catch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> fetch(event.request);</div><div class="line">        &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">            <span class="comment">//console.log(response);</span></div><div class="line">            caches.open(<span class="string">'v1'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</div><div class="line">                <span class="comment">//console.log(cache);</span></div><div class="line">                cache.put(event.request, response);</div><div class="line">            &#125;);</div><div class="line">            <span class="keyword">return</span> response.clone();</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<ol>
<li><code>event.respondWith</code>æ¥å—ä¸€ä¸ªè¿”å›responseå“åº”çš„Promise</li>
<li><code>caches.match</code>ä¼šå°è¯•åœ¨ç¼“å­˜ä¸­åŒ¹é…å½“å‰fetchçš„è¯·æ±‚,åŒ¹é…åˆ°äº†å°±ç›´æ¥è¿”å›response</li>
<li><code>cache.put</code>åˆ™æ˜¯æ›´æ–°ç¼“å­˜</li>
</ol>
<ul>
<li>æ³¨å†Œactivateäº‹ä»¶<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'activate'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> cacheWhitelist = [<span class="string">'v2'</span>];</div><div class="line"></div><div class="line">    event.waitUntil(</div><div class="line">        caches.keys().then(<span class="function"><span class="keyword">function</span>(<span class="params">keyList</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> <span class="built_in">Promise</span>.all(keyList.map(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</div><div class="line">                <span class="keyword">if</span> (cacheWhitelist.indexOf(key) === <span class="number">-1</span>) &#123;</div><div class="line">                    <span class="keyword">return</span> caches.delete(key);</div><div class="line">                &#125;</div><div class="line">            &#125;));</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
</li>
</ul>
<p>activateäº‹ä»¶å›è°ƒä¸€èˆ¬è¢«ç”¨æ¥åˆ é™¤æ—§çš„ç¼“å­˜</p>
<h4 id="æ”¹è¿›åçš„ä»£ç "><a href="#æ”¹è¿›åçš„ä»£ç " class="headerlink" title="æ”¹è¿›åçš„ä»£ç "></a>æ”¹è¿›åçš„ä»£ç </h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'install'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'sw.js install'</span>);</div><div class="line">    event.waitUntil(</div><div class="line">        <span class="comment">//è¿™é‡Œå…ˆä¸å¾€ç¼“å­˜ä¸­å†™</span></div><div class="line">        caches.open(<span class="string">'v1'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> cache.addAll([</div><div class="line">                <span class="comment">// '/demo/service-workers/',</span></div><div class="line">                <span class="comment">// '/demo/service-workers/index.html',</span></div><div class="line">                <span class="comment">// '/demo/service-workers/js/main.js',</span></div><div class="line">                <span class="comment">// '/demo/service-workers/json/data.json',</span></div><div class="line">                <span class="comment">// '/demo/service-workers/images/1.jpg',</span></div><div class="line">                <span class="comment">// '/demo/service-workers/images/2.jpg',</span></div><div class="line">                <span class="comment">// '/demo/service-workers/child.html',</span></div><div class="line">            ]);</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div><div class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'fetch'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    event.respondWith(</div><div class="line">        caches.match(event.request)</div><div class="line">        .then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">            <span class="keyword">if</span> (response) &#123;</div><div class="line">                <span class="comment">//å¦‚æœåŒ¹é…åˆ°äº†</span></div><div class="line">                <span class="keyword">return</span> response;</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                <span class="comment">//å¦‚æœæœ‰èµ„æºæ²¡æœ‰åŒ¹é…(æ¯”å¦‚child.htmlé‡Œé¢çš„è·¨åŸŸå›¾ç‰‡),å°±å…ˆå‘è¯·æ±‚è®¿é—®,ç„¶åç¼“å­˜ä¸€ä»½</span></div><div class="line">                <span class="built_in">console</span>.log(<span class="string">'url not match;'</span> + event.request.url);</div><div class="line">                <span class="keyword">return</span> fetch(event.request).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>) </span>&#123;</div><div class="line">                    <span class="built_in">console</span>.log(response);</div><div class="line">                    caches.open(<span class="string">'v1'</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">cache</span>) </span>&#123;</div><div class="line">                        cache.put(event.request, response);</div><div class="line">                    &#125;);</div><div class="line">                    <span class="keyword">return</span> response.clone();</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;)</div><div class="line">        .catch(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">            <span class="keyword">return</span> fetch(event.request);</div><div class="line">        &#125;)</div><div class="line">    );</div><div class="line">&#125;);</div><div class="line"><span class="keyword">this</span>.addEventListener(<span class="string">'activate'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'activate'</span>)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><a href="https://lh2907883.github.io/store/demo/service-workers/">æ¼”ç¤ºåœ°å€</a></p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API/Using_Service_Workers" target="_blank" rel="external">MDN ä½¿ç”¨ Service Workers</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨&quot;&gt;&lt;a href=&quot;#ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨&quot; class=&quot;headerlink&quot; title=&quot;ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨&quot;&gt;&lt;/a&gt;ä»€ä¹ˆæ˜¯webç¦»çº¿åº”ç”¨&lt;/h2&gt;&lt;p&gt;åœ¨æ­£å¸¸æƒ…å†µä¸‹,å®¢æˆ·ç«¯ä½¿ç”¨HTTPåè®®é€šè¿‡ç½‘ç»œå¾—åˆ°æœåŠ¡å™¨çš„èµ„æº,ç„¶åå±•ç¤º,ä½†æ˜¯
    
    </summary>
    
    
      <category term="javascript" scheme="http://lh2907883.github.io/blog/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>å…³äºXMLHttpRequest</title>
    <link href="http://lh2907883.github.io/blog/2017/05/07/%E5%85%B3%E4%BA%8EXMLHttpRequest/"/>
    <id>http://lh2907883.github.io/blog/2017/05/07/å…³äºXMLHttpRequest/</id>
    <published>2017-05-07T04:37:45.000Z</published>
    <updated>2017-05-07T15:34:46.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="XMLHttpRequestæ˜¯ä»€ä¹ˆ"><a href="#XMLHttpRequestæ˜¯ä»€ä¹ˆ" class="headerlink" title="XMLHttpRequestæ˜¯ä»€ä¹ˆ"></a>XMLHttpRequestæ˜¯ä»€ä¹ˆ</h2><p>XMLHttpRequest æ˜¯ä¸€ä¸ª<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="external">API</a>, å®ƒä¸ºå®¢æˆ·ç«¯æä¾›äº†åœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ è¾“æ•°æ®çš„åŠŸèƒ½ã€‚å®ƒæä¾›äº†ä¸€ä¸ªé€šè¿‡ URL æ¥è·å–æ•°æ®çš„ç®€å•æ–¹å¼ï¼Œå¹¶ä¸”ä¸ä¼šä½¿æ•´ä¸ªé¡µé¢åˆ·æ–°ã€‚è¿™ä½¿å¾—ç½‘é¡µåªæ›´æ–°ä¸€éƒ¨åˆ†é¡µé¢è€Œä¸ä¼šæ‰“æ‰°åˆ°ç”¨æˆ·ã€‚XMLHttpRequest åœ¨ <a href="https://developer.mozilla.org/zh-CN/docs/AJAX" target="_blank" rel="external">AJAX</a> ä¸­è¢«å¤§é‡ä½¿ç”¨ã€‚</p>
<h2 id="å…¼å®¹æ€§"><a href="#å…¼å®¹æ€§" class="headerlink" title="å…¼å®¹æ€§"></a>å…¼å®¹æ€§</h2><p><img src="https://lh2907883.github.io/store/blog/%E5%85%B3%E4%BA%8EXMLHttpRequest/1.png" alt=""></p>
<ul>
<li><p>IE8/IE9ä¹Ÿå®Œå…¨ä¸æ”¯æŒxhrå¯¹è±¡, ä¸è¿‡å¯ä»¥ä½¿ç”¨<a href="https://msdn.microsoft.com/zh-cn/library/7sw4ddf8%28v=vs.94%29.aspx" target="_blank" rel="external">ActiveXObject</a>ç±»ç”Ÿæˆxhrå®ä¾‹</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">new</span> <span class="built_in">window</span>.ActiveXObject( <span class="string">"Microsoft.XMLHTTP"</span> )</div></pre></td></tr></table></figure>
</li>
<li><p>IE10/IE11éƒ¨åˆ†æ”¯æŒï¼Œä¸æ”¯æŒ xhr.responseTypeä¸ºjson</p>
</li>
</ul>
<h2 id="å¦‚ä½•ä½¿ç”¨"><a href="#å¦‚ä½•ä½¿ç”¨" class="headerlink" title="å¦‚ä½•ä½¿ç”¨"></a>å¦‚ä½•ä½¿ç”¨</h2><p>ä½¿ç”¨xhrç»™åå°serverå‘é€è¯·æ±‚,å¤§æ¦‚å¯ä»¥åˆ†ä¸‹é¢å‡ ä¸ªæ­¥éª¤</p>
<h3 id="1-å®ä¾‹åŒ–XMLHttpRequestå¯¹è±¡"><a href="#1-å®ä¾‹åŒ–XMLHttpRequestå¯¹è±¡" class="headerlink" title="1.å®ä¾‹åŒ–XMLHttpRequestå¯¹è±¡"></a>1.å®ä¾‹åŒ–XMLHttpRequestå¯¹è±¡</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div></pre></td></tr></table></figure>
<h3 id="2-åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚"><a href="#2-åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚" class="headerlink" title="2.åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚"></a>2.åˆå§‹åŒ–ä¸€ä¸ªè¯·æ±‚</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xhr.open(<span class="string">'POST'</span>, <span class="string">'/server'</span>, <span class="literal">true</span>);</div></pre></td></tr></table></figure>
<p><code>open(method, url [, async = true [, username = null [, password = null]]])</code></p>
<p>async: é»˜è®¤å€¼ä¸ºtrueï¼Œå³ä¸ºå¼‚æ­¥è¯·æ±‚ï¼Œè‹¥async=falseï¼Œåˆ™ä¸ºåŒæ­¥è¯·æ±‚</p>
<h3 id="3-è®¾ç½®xhrå‚æ•°"><a href="#3-è®¾ç½®xhrå‚æ•°" class="headerlink" title="3.è®¾ç½®xhrå‚æ•°"></a>3.è®¾ç½®xhrå‚æ•°</h3><h4 id="3-1-è®¾ç½®request-header"><a href="#3-1-è®¾ç½®request-header" class="headerlink" title="3.1 è®¾ç½®request header"></a>3.1 è®¾ç½®request header</h4><ol>
<li>é€šè¿‡è°ƒç”¨setRequestHeaderæ–¹æ³•,è®¾ç½®è¯·æ±‚å¤´,è¿™ä¸€æ­¥å¿…é¡»åœ¨<code>xhr.open</code>ä¹‹åè°ƒç”¨</li>
<li>setRequestHeaderå¯ä»¥è°ƒç”¨å¤šæ¬¡ï¼Œæœ€ç»ˆçš„å€¼ä¸ä¼šé‡‡ç”¨è¦†ç›–overrideçš„æ–¹å¼ï¼Œè€Œæ˜¯é‡‡ç”¨è¿½åŠ appendçš„æ–¹å¼<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">xhr.setRequestHeader(<span class="string">'X-Test'</span>, <span class="string">'one'</span>);</div><div class="line">xhr.setRequestHeader(<span class="string">'X-Test'</span>, <span class="string">'two'</span>);</div><div class="line"><span class="comment">// æœ€ç»ˆrequest headerä¸­"X-Test"ä¸º: one, two</span></div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="3-2-è®¾ç½®response-type"><a href="#3-2-è®¾ç½®response-type" class="headerlink" title="3.2 è®¾ç½®response type"></a>3.2 è®¾ç½®response type</h4><ol>
<li>å¯ä»¥è®¾ç½®<code>xhr.responseType</code>,ä¸‹é¢æ˜¯responseTypeæ”¯æŒçš„ç±»å‹</li>
</ol>
<table>
<thead>
<tr>
<th>å€¼</th>
<th>xhr.response æ•°æ®ç±»å‹</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>â€œâ€</td>
<td>String</td>
<td>é»˜è®¤å€¼(åœ¨ä¸è®¾ç½®responseTypeæ—¶)</td>
</tr>
<tr>
<td>â€œtextâ€</td>
<td>String</td>
<td></td>
</tr>
<tr>
<td>â€œdocumentâ€</td>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document" target="_blank" rel="external">Document</a> å¯¹è±¡</td>
<td>å¸Œæœ›è¿”å› XML æ ¼å¼æ•°æ®æ—¶ä½¿ç”¨</td>
</tr>
<tr>
<td>â€œjsonâ€</td>
<td>javascript å¯¹è±¡</td>
<td>å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼ŒIE10/IE11ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>â€œblobâ€</td>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="external">Blob</a>å¯¹è±¡</td>
<td></td>
</tr>
<tr>
<td>â€œarrayBufferâ€</td>
<td><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ArrayBuffer" target="_blank" rel="external">ArrayBuffer</a>å¯¹è±¡</td>
</tr>
</tbody>
</table>
<p>å®¢æˆ·ç«¯ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">xhr.open(<span class="string">'GET'</span>, <span class="string">'/json'</span>);</div><div class="line">xhr.responseType = <span class="string">'json'</span>;</div><div class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.readyState == <span class="number">4</span> &amp;&amp; <span class="keyword">this</span>.status == <span class="number">200</span>) &#123;</div><div class="line">        <span class="comment">//é€šè¿‡xhr.responseå¯ä»¥æ‹¿åˆ°è¿”å›çš„jsonæ•°æ®</span></div><div class="line">        <span class="built_in">console</span>.log(<span class="keyword">this</span>.response);</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">xhr.send();</div></pre></td></tr></table></figure></p>
<p>æœåŠ¡ç«¯ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (req.url == <span class="string">'/json'</span>) &#123;</div><div class="line">    res.writeHead(<span class="number">200</span>, &#123; <span class="string">'content-type'</span>: <span class="string">'application/json'</span> &#125;);</div><div class="line">    res.write(<span class="string">'&#123;"a": 123, "b": "dcs"&#125;'</span>);</div><div class="line">    res.end();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<ol>
<li>é€šè¿‡è°ƒç”¨<code>xhr.overrideMimeType</code>æ–¹æ³•æ¥é‡å†™responseçš„content-type(ä¸è¿‡è¿™ä¸ªæ–¹æ³•æˆ‘è°ƒç”¨ä¹‹åå¹¶æ²¡æœ‰èµ·ä½œç”¨..)</li>
</ol>
<h4 id="3-3-è®¾ç½®è¯·æ±‚è¶…æ—¶"><a href="#3-3-è®¾ç½®è¯·æ±‚è¶…æ—¶" class="headerlink" title="3.3 è®¾ç½®è¯·æ±‚è¶…æ—¶"></a>3.3 è®¾ç½®è¯·æ±‚è¶…æ—¶</h4><p>å¯ä»¥è®¾ç½®<code>xhr.timeout</code>,æ¥è®¾ç½®è¶…æ—¶æ—¶é—´(å•ä½æ¯«ç§’),åœ¨xhr.send()æ–¹æ³•è°ƒç”¨åå¼€å§‹è®¡æ—¶</p>
<h4 id="3-4-è®¾ç½®xhrçŠ¶æ€å˜åŒ–æ—¶çš„å›è°ƒ"><a href="#3-4-è®¾ç½®xhrçŠ¶æ€å˜åŒ–æ—¶çš„å›è°ƒ" class="headerlink" title="3.4 è®¾ç½®xhrçŠ¶æ€å˜åŒ–æ—¶çš„å›è°ƒ"></a>3.4 è®¾ç½®xhrçŠ¶æ€å˜åŒ–æ—¶çš„å›è°ƒ</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">xhr.onreadystatechange = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">switch</span>(xhr.readyState)&#123;</div><div class="line">        <span class="keyword">case</span> <span class="number">0</span>:<span class="comment">//UNSENT,open()æ–¹æ³•æ²¡æœ‰è°ƒç”¨</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">1</span>:<span class="comment">//OPENED,open()æ–¹æ³•å·²è¢«æˆåŠŸè°ƒç”¨,send()æ–¹æ³•è¿˜æœªè¢«è°ƒç”¨ã€‚</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">2</span>:<span class="comment">//HEADERS_RECEIVED,send()æ–¹æ³•å·²ç»è¢«è°ƒç”¨, å“åº”å¤´å’Œå“åº”çŠ¶æ€å·²ç»è¿”å›</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">3</span>:<span class="comment">//LOADING,å“åº”ä½“ä¸‹è½½ä¸­,responseTextä¸­å·²ç»è·å–äº†éƒ¨åˆ†æ•°æ®.</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        <span class="keyword">case</span> <span class="number">4</span>:<span class="comment">//DONE,æ•´ä¸ªè¯·æ±‚è¿‡ç¨‹å·²ç»å®Œæ¯•.</span></div><div class="line">            <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-5-xhrçš„äº‹ä»¶"><a href="#3-5-xhrçš„äº‹ä»¶" class="headerlink" title="3.5 xhrçš„äº‹ä»¶"></a>3.5 xhrçš„äº‹ä»¶</h4><table>
<thead>
<tr>
<th>äº‹ä»¶</th>
<th>è§¦å‘æ¡ä»¶</th>
</tr>
</thead>
<tbody>
<tr>
<td>onreadystatechange</td>
<td>æ¯å½“xhr.readyStateæ”¹å˜æ—¶è§¦å‘ï¼›ä½†xhr.readyStateç”±é0å€¼å˜ä¸º0æ—¶ä¸è§¦å‘ã€‚</td>
</tr>
<tr>
<td>onloadstart</td>
<td>è°ƒç”¨xhr.send()æ–¹æ³•åç«‹å³è§¦å‘ï¼Œè‹¥xhr.send()æœªè¢«è°ƒç”¨åˆ™ä¸ä¼šè§¦å‘æ­¤äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>onprogress</td>
<td>xhr.upload.onprogressåœ¨ä¸Šä¼ é˜¶æ®µ(å³xhr.send()ä¹‹åï¼Œxhr.readystate=2ä¹‹å‰)è§¦å‘ï¼›xhr.onprogressåœ¨ä¸‹è½½é˜¶æ®µï¼ˆå³xhr.readystate=3æ—¶ï¼‰è§¦å‘</td>
</tr>
<tr>
<td>onload</td>
<td>å½“è¯·æ±‚æˆåŠŸå®Œæˆæ—¶è§¦å‘ï¼Œæ­¤æ—¶xhr.readystate=4</td>
</tr>
<tr>
<td>onloadend</td>
<td>å½“è¯·æ±‚ç»“æŸï¼ˆåŒ…æ‹¬è¯·æ±‚æˆåŠŸå’Œè¯·æ±‚å¤±è´¥ï¼‰æ—¶è§¦å‘</td>
</tr>
<tr>
<td>onabort</td>
<td>å½“è°ƒç”¨xhr.abort()åè§¦å‘</td>
</tr>
<tr>
<td>ontimeout</td>
<td>xhr.timeoutä¸ç­‰äº0ï¼Œç”±è¯·æ±‚å¼€å§‹å³onloadstartå¼€å§‹ç®—èµ·ï¼Œå½“åˆ°è¾¾xhr.timeoutæ‰€è®¾ç½®æ—¶é—´è¯·æ±‚è¿˜æœªç»“æŸå³onloadendï¼Œåˆ™è§¦å‘æ­¤äº‹ä»¶ã€‚</td>
</tr>
<tr>
<td>onerror</td>
<td>åœ¨è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œè‹¥å‘ç”ŸNetwork erroråˆ™ä¼šè§¦å‘æ­¤äº‹ä»¶ï¼ˆè‹¥å‘ç”ŸNetwork erroræ—¶ï¼Œä¸Šä¼ è¿˜æ²¡æœ‰ç»“æŸï¼Œåˆ™ä¼šå…ˆè§¦å‘xhr.upload.onerrorï¼Œå†è§¦å‘xhr.onerrorï¼›è‹¥å‘ç”ŸNetwork erroræ—¶ï¼Œä¸Šä¼ å·²ç»ç»“æŸï¼Œåˆ™åªä¼šè§¦å‘xhr.onerrorï¼‰ã€‚<strong>æ³¨æ„</strong>ï¼Œåªæœ‰å‘ç”Ÿäº†ç½‘ç»œå±‚çº§åˆ«çš„å¼‚å¸¸æ‰ä¼šè§¦å‘æ­¤äº‹ä»¶ï¼Œå¯¹äºåº”ç”¨å±‚çº§åˆ«çš„å¼‚å¸¸ï¼Œå¦‚å“åº”è¿”å›çš„xhr.statusCodeæ˜¯4xxæ—¶ï¼Œå¹¶ä¸å±äºNetwork errorï¼Œæ‰€ä»¥ä¸ä¼šè§¦å‘onerroräº‹ä»¶ï¼Œè€Œæ˜¯ä¼šè§¦å‘onloadäº‹ä»¶ã€‚</td>
</tr>
</tbody>
</table>
<h3 id="4-å‘é€æ•°æ®"><a href="#4-å‘é€æ•°æ®" class="headerlink" title="4.å‘é€æ•°æ®"></a>4.å‘é€æ•°æ®</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">xhr.send(data);</div></pre></td></tr></table></figure>
<ul>
<li>å¯¹äºGET/HEADè¯·æ±‚<code>send</code>æ–¹æ³•é€šå¸¸ä¸ä¼ å‚æ•°</li>
<li>å¯¹äºPOST/DELETE/PUTè¯·æ±‚,<code>xhr.send(data)</code>çš„å‚æ•°dataå¯ä»¥æ˜¯ä»¥ä¸‹å‡ ç§ç±»å‹ï¼š<ul>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/ArrayBuffer" target="_blank" rel="external">ArrayBuffer</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Blob" target="_blank" rel="external">Blob</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document" target="_blank" rel="external">Document</a></li>
<li>DOMString</li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/FormData" target="_blank" rel="external">FormData</a></li>
</ul>
</li>
</ul>
<p>æ¥ä¸€ä¸ªğŸŒ°</p>
<p>å®¢æˆ·ç«¯ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fileInputElement = <span class="built_in">document</span>.getElementById(<span class="string">'file'</span>)</div><div class="line"></div><div class="line"><span class="keyword">var</span> oMyForm = <span class="keyword">new</span> FormData();</div><div class="line"></div><div class="line">oMyForm.append(<span class="string">"username"</span>, <span class="string">"dcs"</span>);</div><div class="line">oMyForm.append(<span class="string">"num"</span>, <span class="number">123456</span>); <span class="comment">// æ•°å­—123456è¢«ç«‹å³è½¬æ¢æˆå­—ç¬¦ä¸²"123456"</span></div><div class="line"></div><div class="line"><span class="comment">// fileInputElementä¸­å·²ç»åŒ…å«äº†ç”¨æˆ·æ‰€é€‰æ‹©çš„æ–‡ä»¶</span></div><div class="line"><span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; fileInputElement.files.length; i++) &#123;</div><div class="line">    oMyForm.append(<span class="string">"file"</span>, fileInputElement.files[i]);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">var</span> oFileBody = <span class="string">'&lt;a id="a"&gt;&lt;b id="b"&gt;hey!&lt;/b&gt;&lt;/a&gt;'</span>; <span class="comment">// Blobå¯¹è±¡åŒ…å«çš„æ–‡ä»¶å†…å®¹</span></div><div class="line"><span class="keyword">var</span> oBlob = <span class="keyword">new</span> Blob([oFileBody], &#123;</div><div class="line">    <span class="attr">type</span>: <span class="string">"text/xml"</span></div><div class="line">&#125;);</div><div class="line">oMyForm.append(<span class="string">"blob"</span>, oBlob);</div><div class="line"></div><div class="line"><span class="keyword">var</span> xhr = <span class="keyword">new</span> XMLHttpRequest();</div><div class="line">xhr.upload.onprogress = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</div><div class="line">    <span class="keyword">if</span> (event.lengthComputable) &#123;</div><div class="line">        <span class="keyword">var</span> completedPercent = event.loaded / event.total;</div><div class="line">        <span class="built_in">console</span>.log(completedPercent);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">xhr.open(<span class="string">"POST"</span>, <span class="string">"/upload"</span>);</div><div class="line">xhr.send(oMyForm);</div></pre></td></tr></table></figure></p>
<p>æœåŠ¡ç«¯ä»£ç <br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (req.url == <span class="string">'/upload'</span> &amp;&amp; req.method.toLowerCase() == <span class="string">'post'</span>) &#123;</div><div class="line">    req.on(<span class="string">'data'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">buffer</span>) </span>&#123;</div><div class="line">        <span class="comment">//ä¼šä¸æ—¶çš„è§¦å‘dataäº‹ä»¶æ¥æ¥å—å®¢æˆ·ç«¯ä¼ é€’çš„æ•°æ®</span></div><div class="line">    &#125;)</div><div class="line">    .on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</div><div class="line">        <span class="comment">//æ•°æ®ä¼ é€’å®Œæ¯•</span></div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><strong>æ³¨æ„</strong>: å®¢æˆ·ç«¯çš„<code>xhr.upload.onprogress</code>è¡¨ç¤ºçš„æ˜¯ä¸Šä¼ è¿›åº¦è§¦å‘çš„å›è°ƒ(è¿›åº¦å–å†³äºå®¢æˆ·ç«¯çš„ç½‘ç»œçŠ¶å†µ),å‚æ•°<code>event.total</code>é’ˆå¯¹çš„æ˜¯æ‰€æœ‰fileçš„æ€»å¤§å°, è€ŒæœåŠ¡ç«¯çš„<code>req.on(&#39;data&#39;, function(){})</code>åªæ˜¯è¿™æ¬¡è¯·æ±‚çš„æ•°æ®æµæ¥å—ä¸€å®šé‡çš„æ•°æ®åè§¦å‘çš„å›è°ƒ,ä¸¤è€…ä¹‹é—´æ²¡æœ‰ç›´æ¥å…³ç³»</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><ul>
<li><a href="https://segmentfault.com/a/1190000004322487" target="_blank" rel="external">ä½ çœŸçš„ä¼šä½¿ç”¨XMLHttpRequestå—ï¼Ÿ</a></li>
<li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest" target="_blank" rel="external">MDN XMLHttpRequest</a></li>
<li><a href="https://www.html5rocks.com/zh/tutorials/file/xhr2/" target="_blank" rel="external">XMLHttpRequest2 æ–°æŠ€å·§</a></li>
</ul>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;XMLHttpRequestæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;a href=&quot;#XMLHttpRequestæ˜¯ä»€ä¹ˆ&quot; class=&quot;headerlink&quot; title=&quot;XMLHttpRequestæ˜¯ä»€ä¹ˆ&quot;&gt;&lt;/a&gt;XMLHttpRequestæ˜¯ä»€ä¹ˆ&lt;/h2&gt;&lt;p&gt;XMLHttpReq
    
    </summary>
    
    
      <category term="javascript" scheme="http://lh2907883.github.io/blog/tags/javascript/"/>
    
  </entry>
  
  <entry>
    <title>Hello World</title>
    <link href="http://lh2907883.github.io/blog/2017/05/06/hello-world/"/>
    <id>http://lh2907883.github.io/blog/2017/05/06/hello-world/</id>
    <published>2017-05-06T08:43:45.000Z</published>
    <updated>2017-05-13T08:19:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/" target="_blank" rel="external">Hexo</a>! This is your very first post. Check <a href="https://hexo.io/docs/" target="_blank" rel="external">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a href="https://hexo.io/docs/troubleshooting.html" target="_blank" rel="external">troubleshooting</a> or you can ask me on <a href="https://github.com/hexojs/hexo/issues" target="_blank" rel="external">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo new <span class="string">"My New Post"</span></div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/writing.html" target="_blank" rel="external">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo server</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/server.html" target="_blank" rel="external">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo generate</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/generating.html" target="_blank" rel="external">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ hexo deploy</div></pre></td></tr></table></figure>
<p>More info: <a href="https://hexo.io/docs/deployment.html" target="_blank" rel="external">Deployment</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Welcome to &lt;a href=&quot;https://hexo.io/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Hexo&lt;/a&gt;! This is your very first post. Check &lt;a href=&quot;https://hexo.
    
    </summary>
    
    
  </entry>
  
</feed>
